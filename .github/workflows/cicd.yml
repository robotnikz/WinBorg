name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]

jobs:
  # JOB 1: QUALITY ASSURANCE
  # Runs Typechecks and Unit Tests
  test:
    name: Run Tests & Typecheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Type Check (TypeScript)
        run: npx tsc --noEmit

      - name: Run Unit Tests
        run: npx vitest run

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run E2E Tests (Headless)
        run: xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" npm run test:e2e

  # JOB 2: Semantic Release
  # Only runs if tests pass AND we are on main branch (not PRs)
  release:
    name: Semantic Release
    needs: test # WAITS FOR TESTS TO PASS
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
    runs-on: windows-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22' # Compatible with semantic-release

      - name: Install dependencies
        run: npm ci

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release
